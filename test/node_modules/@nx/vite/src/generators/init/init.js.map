{"version":3,"sources":["../../../../../../packages/vite/src/generators/init/init.ts"],"sourcesContent":["import {\n  addDependenciesToPackageJson,\n  convertNxGenerator,\n  logger,\n  readJson,\n  readNxJson,\n  runTasksInSerial,\n  Tree,\n  updateJson,\n  updateNxJson,\n} from '@nx/devkit';\n\nimport { initGenerator as jsInitGenerator } from '@nx/js';\n\nimport {\n  jsdomVersion,\n  nxVersion,\n  vitePluginDtsVersion,\n  vitePluginReactVersion,\n  vitePluginReactSwcVersion,\n  vitestUiVersion,\n  vitestVersion,\n  viteTsConfigPathsVersion,\n  viteVersion,\n  happyDomVersion,\n  edgeRuntimeVmVersion,\n} from '../../utils/versions';\nimport { InitGeneratorSchema } from './schema';\n\nfunction checkDependenciesInstalled(host: Tree, schema: InitGeneratorSchema) {\n  const packageJson = readJson(host, 'package.json');\n  const devDependencies = {};\n  const dependencies = {};\n  packageJson.dependencies = packageJson.dependencies || {};\n  packageJson.devDependencies = packageJson.devDependencies || {};\n\n  // base deps\n  devDependencies['@nx/vite'] = nxVersion;\n  devDependencies['vite'] = viteVersion;\n  devDependencies['vite-tsconfig-paths'] = viteTsConfigPathsVersion;\n  devDependencies['vitest'] = vitestVersion;\n  devDependencies['@vitest/ui'] = vitestUiVersion;\n\n  if (schema.testEnvironment === 'jsdom') {\n    devDependencies['jsdom'] = jsdomVersion;\n  } else if (schema.testEnvironment === 'happy-dom') {\n    devDependencies['happy-dom'] = happyDomVersion;\n  } else if (schema.testEnvironment === 'edge-runtime') {\n    devDependencies['@edge-runtime/vm'] = edgeRuntimeVmVersion;\n  } else if (schema.testEnvironment !== 'node') {\n    logger.info(\n      `A custom environment was provided: ${schema.testEnvironment}. You need to install it manually.`\n    );\n  }\n\n  if (schema.uiFramework === 'react') {\n    if (schema.compiler === 'swc') {\n      devDependencies['@vitejs/plugin-react-swc'] = vitePluginReactSwcVersion;\n    } else {\n      devDependencies['@vitejs/plugin-react'] = vitePluginReactVersion;\n    }\n  }\n\n  if (schema.includeLib) {\n    devDependencies['vite-plugin-dts'] = vitePluginDtsVersion;\n  }\n\n  return addDependenciesToPackageJson(host, dependencies, devDependencies);\n}\n\nfunction moveToDevDependencies(tree: Tree) {\n  updateJson(tree, 'package.json', (packageJson) => {\n    packageJson.dependencies = packageJson.dependencies || {};\n    packageJson.devDependencies = packageJson.devDependencies || {};\n\n    if (packageJson.dependencies['@nx/vite']) {\n      packageJson.devDependencies['@nx/vite'] =\n        packageJson.dependencies['@nx/vite'];\n      delete packageJson.dependencies['@nx/vite'];\n    }\n    return packageJson;\n  });\n}\n\nexport function createVitestConfig(tree: Tree) {\n  const nxJson = readNxJson(tree);\n\n  const productionFileSet = nxJson.namedInputs?.production;\n  if (productionFileSet) {\n    productionFileSet.push(\n      '!{projectRoot}/**/?(*.)+(spec|test).[jt]s?(x)?(.snap)',\n      '!{projectRoot}/tsconfig.spec.json'\n    );\n\n    nxJson.namedInputs.production = Array.from(new Set(productionFileSet));\n  }\n\n  nxJson.targetDefaults ??= {};\n  nxJson.targetDefaults.test ??= {};\n  nxJson.targetDefaults.test.inputs ??= [\n    'default',\n    productionFileSet ? '^production' : '^default',\n  ];\n\n  updateNxJson(tree, nxJson);\n}\n\nexport async function initGenerator(tree: Tree, schema: InitGeneratorSchema) {\n  moveToDevDependencies(tree);\n  createVitestConfig(tree);\n  const tasks = [];\n\n  tasks.push(\n    await jsInitGenerator(tree, {\n      ...schema,\n      skipFormat: true,\n    })\n  );\n\n  tasks.push(checkDependenciesInstalled(tree, schema));\n  return runTasksInSerial(...tasks);\n}\n\nexport default initGenerator;\nexport const initSchematic = convertNxGenerator(initGenerator);\n"],"names":["createVitestConfig","initGenerator","initSchematic","checkDependenciesInstalled","host","schema","packageJson","readJson","devDependencies","dependencies","nxVersion","viteVersion","viteTsConfigPathsVersion","vitestVersion","vitestUiVersion","testEnvironment","jsdomVersion","happyDomVersion","edgeRuntimeVmVersion","logger","info","uiFramework","compiler","vitePluginReactSwcVersion","vitePluginReactVersion","includeLib","vitePluginDtsVersion","addDependenciesToPackageJson","moveToDevDependencies","tree","updateJson","nxJson","readNxJson","productionFileSet","namedInputs","production","push","Array","from","Set","targetDefaults","test","inputs","updateNxJson","tasks","jsInitGenerator","skipFormat","runTasksInSerial","convertNxGenerator"],"mappings":"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"}